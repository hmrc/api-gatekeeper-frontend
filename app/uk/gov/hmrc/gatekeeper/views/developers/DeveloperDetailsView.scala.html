@*
 * Copyright 2022 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.gatekeeper.controllers._
@import uk.gov.hmrc.gatekeeper.models._
@import uk.gov.hmrc.gatekeeper.config.AppConfig
@import uk.gov.hmrc.apiplatform.modules.gkauth.domain.models.LoggedInRequest
@import uk.gov.hmrc.gatekeeper.models.xml.OrganisationId
@import uk.gov.hmrc.gatekeeper.controllers.routes

@this(main: NewMainView, applicationConfig: AppConfig)


@(developer: Developer, gatekeeperXmlServicesUrlFn: (OrganisationId) => String)(implicit loggedInRequest: LoggedInRequest[_])

@main(title = s"${applicationConfig.title} - Developer Details") {

  <h1 class="govuk-heading-l">@developer.email</h1>

  <dl class="govuk-summary-list" id="developer-information">
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">
        First name
      </dt>
      <dd class="govuk-summary-list__value" id="first-name">
        @developer.firstName
      </dd>
    </div>
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">
        Last name
      </dt>
      <dd class="govuk-summary-list__value" id="last-name">
        @developer.lastName
      </dd>
    </div>
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">
        Status
      </dt>
      <dd class="govuk-summary-list__value" id="status">
        @defining(developer.status match {
          case VerifiedStatus => ("status status--verified", "verified")
          case UnverifiedStatus => ("status status--not-verified", "not yet verified")
          case _ => ("status", "unregistered")
        }) { case (cssStyle, text) => <span class="@cssStyle">@text</span> }
      </dd>
    </div>
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">
        Organisation
      </dt>
      <dd class="govuk-summary-list__value" id="organisation">
        @(developer.organisation match {
          case Some(text) => text
          case None => ""
        })
      </dd>
    </div>
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">
        2SV Enabled
      </dt>
      <dd class="govuk-summary-list__value" id="mfaEnabled">
        @(developer.mfaEnabled match {
          case true => "Yes"
          case false => "No"
        })
      </dd>
    </div>
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">
        User ID
      </dt>
      <dd class="govuk-summary-list__value" id="userId">
        @developer.id
      </dd>
    </div>
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">
        XML email preferences
      </dt>
      <dd class="govuk-summary-list__value" id="xmlEmailPreferences">
        @if(developer.xmlEmailPrefServices.nonEmpty) {
          @for(e <- developer.xmlEmailPrefServices) {@e <br>}
        } else { None }
      </dd>
    </div>
  </dl>

  <h2 class="govuk-heading-m">Associated applications</h2>

  @if(developer.applications.isEmpty) {
    <p class="govuk-body" id="applications">None</p>
  } else {
    <dl class="govuk-summary-list" id="applications">
      @for(app <- developer.applications) {
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">
            <a href="@{routes.ApplicationController.applicationPage(app.id)}">@app.name</a>
          </dt>
          <dd class="govuk-summary-list__value">
            <p class="govuk-body">@app.deployedTo.toLowerCase.capitalize</p>
            <p class="govuk-body">
              @app.collaborators.filter(_.emailAddress == developer.email).map(_.role match {
                case CollaboratorRole.ADMINISTRATOR => "Admin"
                case CollaboratorRole.DEVELOPER => "Developer"
              })
            </p>
          </dd>
        </div>
      }
    </dl>
  }

  <h2 class="govuk-heading-m">Associated XML organisations</h2>

  @if(developer.xmlOrganisations.isEmpty) {
    <p class="govuk-body" id="xml-organisation">None</p>
  } else {
    @for(organisation <- developer.xmlOrganisations) {
      <ul class="govuk-list">
        <li id="xml-organisation-td">
          <a id="xml-organisation-link" class="govuk-link" href="@gatekeeperXmlServicesUrlFn(organisation.organisationId)">@organisation.name</a>
        </li>
      </ul>
    }
  }

  <br>

  @if(loggedInRequest.role.isSuperUser) {
    <a
      id="delete-developer"
      href="@{routes.DevelopersController.deleteDeveloperPage(UuidIdentifier(developer.user.userId))}"
      class="govuk-button govuk-button--warning"
    >
      Delete developer
    </a>
  }

  @if(developer.mfaEnabled) {
    @if(loggedInRequest.role.isUser) {
      <a
        id="remove-2SV"
        href="@{routes.DevelopersController.removeMfaPage(UuidIdentifier(developer.user.userId))}"
        class="govuk-button"
      >
        Remove 2SV
      </a>
    }
  }
}
